{% load comments %}
{% load mptt_tags %}
{% load comment_extras %}
{% load i18n %}
{% include 'comments/comment_preview.html' %}


<h3 class="title text-center">
    <a name="comments">{% trans "Post your comment" %}</a>
</h3>

{% if user.is_authenticated %}
    {% get_comment_form for object as form %}
    <form id="live-preview-form" action="{% comment_form_target %}" method="POST">
        {% csrf_token %}
        <div class="media media-post">
            <div class="media-body">
                <div class="form-group label-floating bmd-form-group">
                    <div class="form-group has-warning">
                        <textarea placeholder="{% trans 'Write your comment' %}" class="form-control" rows="5"  name="comment" required></textarea>
                    </div>
                    {{ form.content_type }}
                    {{ form.object_pk }}
                    {{ form.timestamp }}
                    {{ form.security_hash }}
                    {{ form.parent }}
                </div>
                <div class="media-footer">
                    <input class="btn btn-warning btn-wd float-right" type="submit" value="{% trans 'Post' %}" />
                </div>
            </div>
        </div>
    </form>
{% else %}
    <h4 class="text-center">
        {% trans "Please sign in to leave a comment" %}
    </h4>
    <br>
{% endif %}

{% get_comment_count for object as comment_count %}
{% get_comment_list for object as comments %}

<div class="media-area">
    <h3 class="title text-center">{{ comment_count }} {% trans "Comments" %}</h3>

    <ul class="nav nav-pills nav-pills-info">
        <li class="nav-item">
            <a class="nav-link active" href="#pill1" data-toggle="tab">{% trans "Best" %}</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#pill2" data-toggle="tab">{% trans "Recent" %}</a>
        </li>
    </ul>

    <div class="tab-content tab-space">
        <div class="tab-pane active" id="pill1">
            {% promotionorderedcursetree comments %}
                {% include "comments/comment_detail.html" %}
            {% endrecursetree %}
        </div>
        <div class="tab-pane" id="pill2">
            {% dateorderedcursetree comments %}
                {% include "comments/comment_detail.html" %}
            {% endrecursetree %}
        </div>
    </div>
</div>

<script>
    function toggleDiv(divId) {
       $("."+divId).toggle();
    }

    function updateText(btn, newCount, verb){
        btn.attr("data-promotions", newCount)
        icon = "<i class='fal fa-thumbs-up fa-lg'></i>"
        suffix = newCount
        btn.html(icon + " " + suffix)        
    }

    $(".btn-promote").click(function(e){
        e.preventDefault()
        var this_ = $(this)
        var promoteUrl = this_.attr("data-href")
        var promotionsCount = parseInt(this_.attr("data-promotions"))
        var addPromotion = promotionsCount + 1
        var removePromotion = promotionsCount - 1
        $.ajax({
            url: promoteUrl,
            method: "GET",
            data: {},
            success: function(data){
                console.log(data)
                var newPromotions;
                var newLabel;
                if (data.promoted){
                    updateText(this_, addPromotion, "{% trans 'Demote' %}")
                    this_.addClass("btn-warning")
                } else {
                    updateText(this_, removePromotion, "{% trans 'Promote' %}")
                    this_.removeClass("btn-warning")
                }            
            }, error: function(error){
                console.log(error)
                console.log("error")
            }
        })
    })
</script>